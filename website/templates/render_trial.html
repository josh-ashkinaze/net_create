<!DOCTYPE html>
<html lang="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experiment</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
          crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.10.2/Sortable.min.js"></script>

    <style>

        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .dialog-box {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .dialog-box h3 {
            color: #1F4287;
            margin-bottom: 10px;
        }

        .dialog-box p {
            margin-bottom: 20px;
        }

        .dialog-box button {
            background-color: #1F4287;
            border-color: #1F4287;
            border-radius: 50px;
            padding: 12px 30px;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
        }

        .dialog-box button:hover {
            background-color: #0E2A56;
            border-color: #0E2A56;
        }


        body {
            background-image: linear-gradient(to top right, #F7C1BB, #E1DD8F);
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin-top: 5rem;
            min-height: 100vh;
        }

        h3 {
            color: #1F4287;
            border-bottom: 3px solid #1F4287;
            display: inline-block;
            padding-bottom: 5px;
        }

        h4 {
            color: #1F4287;
            margin-top: 2rem;
        }

        li {
            margin-bottom: 0.5rem;
        }

        .noselect {
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
            -khtml-user-select: none; /* Konqueror HTML */
            -moz-user-select: none; /* Old versions of Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently supported by Chrome, Opera and Firefox */
        }

        .container {
            max-width: 800px;
        }

        .btn-primary {
            background-color: #1F4287;
            border-color: #1F4287;
            border-radius: 25px;
            padding: 10px 30px;
        }

        .btn-primary:hover {
            background-color: #0E2A56;
            border-color: #0E2A56;
        }

        .sortable-list {
            list-style-type: none;
            padding: 0;
        }

        .sortable-list li {
            margin: 0.5rem;
            padding: 1rem;
            border: 1px solid white;
            border-radius: 5px;
            color: #212529;
            background-color: white;
        }


        .sortable-list li.ai-generated {
            background-color: #B33F62;
            color: white;
        }

        .sortable-list li.human-generated {
            background-color: #1F4287;
            color: white;
        }


        .ai-generated {
            padding: 0.3rem;
            border: 1px solid white;
            border-radius: 5px;
            background-color: #B33F62;
            color: white;
        }

        .sortable-list li.human-generated {
            background-color: #1F4287;
            color: white;
        }

    </style>
</head>
<body class="container py-4">
<h3>Item {{ trial_no }} of 5: Generate a creative use for {% if item != 'pants' %}a {% endif %}<strong>{{ item
    }}</strong>.</h3>
<h4> Task </h4>

<p>For this task, you should write down an original and creative use for {% if item != 'pants' %}a {% endif %}<strong>{{
    item }}</strong>. Certainly there are common, unoriginal ways to use {% if item != 'pants' %}a {% endif %}<strong>{{
    item }}</strong>.
    But for this task, write down the most unusual, creative, and uncommon use you can think of.</p>


{% if label %}
<h4 class='ai-generated'>
    {{ label }}
</h4>
{% endif %}

<h4> Before you answer... </h4>
<ul>
    <li >Read previous ideas.</li>
    <li>Rank these ideas in order of creativity with the most creative use on top. Make at least 1 change. </li>
</ul>


<ul class="sortable-list">

{% for row, r_id in data %}
{% if "(Source: <strong>A.I</strong>)</span>" in row %}
<li class="noselect ai-generated" data-r-id="{{ r_id }}">
    <span class="rank"></span> {{ row|safe }}
</li>
{% elif "(Source: <strong>Human</strong>)</span>" in row %}
<li class="noselect human-generated" data-r-id="{{ r_id }}">
    <span class="rank"></span> {{ row|safe }}
</li>
{% else %}
<li class="noselect human-generated" data-r-id="{{ r_id }}">
    <span class="rank"></span> {{ row|safe }}
</li>
{% endif %}
{% endfor %}
</ul>

<div id="dialogOverlay" class="dialog-overlay" style="display: none;">
    <div class="dialog-box">
        <h3>Similarity Score</h3>
        <p id="similarityScore"></p>
        <button onclick="closeDialog()">Keep going</button>
    </div>
</div>

<form action="{{ url_for('render_trial', condition_no=condition_no) }}" method="post" class="mt-20">
    <div class="form-group">
        <input type="hidden" name="init_array" value="{{ init_array }}">
        <input type="hidden" name="ranked_array" value="">
        <input type="text" class="form-control" name="participant_response" required placeholder="Write your idea here">
    </div>
    <button type="submit" class="btn btn-primary">Submit</button>
</form>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

<script>

    document.addEventListener('DOMContentLoaded', (event) => {
        var sortable = new Sortable(document.querySelector('.sortable-list'), {
            animation: 150,
            chosenClass: "sortable-chosen",
            dragClass: "sortable-drag",
            onSort: function (evt) {
                updateRIdArray();
            }
        });

        function updateRIdArray() {
            var rIdArray = [];
            var listItems = document.querySelectorAll('.sortable-list li');
            listItems.forEach(function (item, index) {
                rIdArray.push(item.dataset.rId);
                item.querySelector('.rank').textContent = (index + 1) + '. ';
            });
            document.querySelector('input[name="ranked_array"]').value = rIdArray.join(',');
        }

        updateRIdArray();
    });


    // Function to display the dialog box with the similarity score
    function showDialog(similarityScore) {
        var dialogOverlay = document.getElementById("dialogOverlay");
        var similarityScoreElement = document.getElementById("similarityScore");
        similarityScoreElement.textContent = "Your response was " + similarityScore + "% similar to the last person's response!";
        dialogOverlay.style.display = "flex";
    }

    // // Function to close the dialog box
    // function closeDialog() {
    //     var dialogOverlay = document.getElementById("dialogOverlay");
    //     dialogOverlay.style.display = "none";
    //     document.querySelector('form').submit();
    //
    // }

    function closeDialog() {
        var dialogOverlay = document.getElementById("dialogOverlay");
        var submitButton = document.querySelector('button[type="submit"]');

        dialogOverlay.style.display = "none";
        submitButton.textContent = "Loading...";
        submitButton.disabled = true;

        document.querySelector('form').submit();
    }

    document.addEventListener('DOMContentLoaded', (event) => {
        // Add an event listener to the form submission
        document.querySelector('form').addEventListener('submit', function (event) {
            event.preventDefault();  // Prevent the form from submitting

            // Get the participant's response
            var response = document.querySelector('input[name="participant_response"]').value;

            var initArray = $('input[name="init_array"]').val();
            var rankedArray = $('input[name="ranked_array"]').val();
            // Check if initial array and ranked array are same
            if (initArray === rankedArray) {
                // If yes, alert the user and stop form submission
                alert("Please move at least one ranking before continuing!");
                return;
            }
            // Perform any necessary submission logic here
            // For example, you can use AJAX to send the response to the server

            // Calculate the similarity score (replace this with your own calculation logic)
            var similarityScore = calculateSimilarity(response);

            // Display the dialog box with the similarity score
            showDialog(similarityScore);
        });
    });


    function calculateSimilarity(response) {
        $.ajax({
            type: "POST",
            url: "{{ url_for('calculate_similarity_route') }}",
            data: {response: response},
            success: function (score) {
                // Display the similarity score in the dialog box
                showDialog(score);
            },
            error: function (xhr, status, error) {
                // Handle error if the request fails
                console.log("Error:", error);
            }
        });
    }


    function updateRIdArray() {
        var sortedRIds = [];
        $('.sortable-list li').each(function (index) {
            $(this).find('.rank').text((index + 1) + ")");
            sortedRIds.push($(this).attr('data-r-id'));
        });
        $('input[name="ranked_array"]').val(sortedRIds.join(','));
    }

    // Call the function once when the document is ready to initialize the ranks
    $(document).ready(function () {
        updateRIdArray();
    });

</script>

</body>
</html>